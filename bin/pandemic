#!/usr/bin/env python

import argparse
import os
import sys
from configparser import ConfigParser
from functools import partial

from Pandemic.bundle import Bundle
from Pandemic.bundle import actioners
from Pandemic import printer

DEF_CONFIG = "~/.vim/pandemic-bundles"
DEF_BUNDLEDIR = "~/.vim/bundle.remote"


class Pandemic:
    bundles = {}

    def __init__(self, actionstr, config, bundledir):

        self.bundledir = os.path.expanduser(bundledir)

        if not os.path.exists(self.bundledir):
            os.mkdir(self.bundledir)

        self.config = os.path.expanduser(config)

        if len(actionstr):
            action_args = actionstr[1:]

            actions = {
                "list": self.list,
                "add": self.add,
                "remove": self.remove,
                "update": self.update,
                "list-dead": self.listdead,
            }

            if actionstr[0] not in actions:
                printer.error("Invalid action.")

            self.action = actions[actionstr[0]]

            self.parse_config()
            self.action(action_args)
        else:
            printer.error("No action specified.")
            sys.exit(1)

    def parse_config(self):
        cfg = ConfigParser()
        cfg.read(self.config)

        self.bundles = {}

        optioned = partial(cfg.has_option, bundle)
        for bundle in cfg.sections():
            if not optioned("source") or not optioned("type"):
                printer.error("Bundle '%s' is malformed." % bundle)
                continue

            # append bundle to bundle list
            self.__append_to_bundles(
                bundle, cfg.get(bundle, "source"), cfg.get(bundle, "type")
            )

    def save_config(self):
        cfg = ConfigParser()
        for b in sorted(self.bundles.keys()):
            bundle = self.bundles[b]
            cfg.add_section(b)
            cfg.set(b, "source", bundle.source)
            cfg.set(b, "type", bundle.btype)

        f = open(self.config, "w")
        cfg.write(f)
        f.close()

    def list(self, args):
        for b in sorted(self.bundles.keys()):
            bundle = self.bundles[b]
            if b == bundle.bname:
                e = "enabled"
            else:
                e = "disabled"
            printer.info("%s: %s %s %s" % (b, e, bundle.btype, bundle.source))

    def add(self, args):
        bundle, btype, source = args

        # add the new bundle to the list
        self.__append_to_bundles(bundle, source, btype)
        # get the new bundle to the directory
        self.bundles[bundle].clone()
        # save the new bundle list
        self.save_config()

    def remove(self, args):
        if len(args) > 1 and args[0] == "-k":
            printer.warn("Keeping bundle '%s'... this is a bad idea." % bundle)
            keep = True
            bundles = args[1:]
        else:
            keep = False
            bundles = args

        for bundle in bundles:
            if not keep:
                self.bundles[bundle].remove()

            self.__delete_from_bundles(bundle)

        self.save_config()

    def update(self, args):
        bundles = args if args else self.bundles.keys()
        for bundle in bundles:
            printer.info("Updating %s..." % bundle)
            self.bundles[bundle].update()

    def listdead(self, args):
        # list bundles that are no longer in the config
        found_bundles = os.listdir(self.bundledir)

        for bundle in found_bundles:
            if bundle not in self.bundles:
                printer.info("Bundle %s not found in database." % bundle)

        for bundle in self.bundles:
            if bundle not in found_bundles:
                printer.info(
                    "Bundle %s not found on filesystem.  Run pandemic update." % bundle
                )

    def __append_to_bundles(self, bundle, source, btype):
        self.bundles[bundle] = Bundle(
            bundle, source, btype, self.bundledir
        )

    def __delete_from_bundles(self, bundle):
        del self.bundles[bundle]


def parse_args():
    p = argparse.ArgumentParser(description="Manage vim-pathogen bundles.")
    p.add_argument(
        "-c",
        "--config",
        dest="config",
        action="store",
        default=DEF_CONFIG,
        help="remote bundle configuration file",
    )
    p.add_argument(
        "-b",
        "--bundle-directory",
        dest="bundledir",
        action="store",
        default=DEF_BUNDLEDIR,
        help="directory contaning pandemic-managed bundles",
    )
    p.add_argument(
        "-t",
        "--show-types",
        dest="showtypes",
        action="store_true",
        default=False,
        help="show supported source types",
    )
    p.add_argument(
        dest="action",
        action="store",
        nargs="*",
        help="action (list, add BUNDLE TYPE SOURCE, remove BUNDLE, update [BUNDLE, BUNDLE, ...], list-dead)",
    )
    return p.parse_args()


def main():
    args = parse_args()
    if args.showtypes:
        printer.info("Supported types: %s" % " ".join(actioners.keys()))
    pan = Pandemic(args.action, args.config, args.bundledir)
    return os.EX_OK


if __name__ == "__main__":
    sys.exit(main())
